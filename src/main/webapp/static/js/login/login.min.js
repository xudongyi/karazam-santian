/*
 * Copyright 2016 klzan.com. All rights reserved.
 * Support: http://www.klzan.com
 *
 * JavaScript - Login
 * Version: 3.0
 */
$().ready( function() {
	var $loginForm = $("#loginForm"), $submit = $loginForm.find(":submit"), $flashMessage = $("#flashMessage");
	var $username = $("#username"), $password = $("#password");
	$submit.prop("disabled", false);
	$loginForm.validate({
		errorClass: "errorMessage",
		rules: {
			username: {
				required: true,
				pattern: /^1[3|4|5|7|8][0-9]{9}$/,
				minlength: 2
			},
			password: {
				required: true,
				minlength: 4
			}
		},
		messages: {
			username: {
				required: "请输入手机号",
				pattern: "请输入正确的手机号码",
				minlength: "用户名最小长度为2"
			},
			password: {
				required: "请输入密码",
				minlength: "密码最小长度为4"
			}
		},
		errorPlacement: function(error, element) {
			element.closest(".errorcls").find(".errorMessage").text(error.text());
			element.closest(".errorcls").find(".errorMessage").addClass("icon");
			$flashMessage.text("")
		},
		unhighlight: function(element) {
			$flashMessage.text("")
			$(element).closest(".errorcls").find(".errorMessage").text("");
			$(element).closest(".errorcls").find(".errorMessage").removeClass("icon");
		},
		submitHandler: function(form) {
			$submit.prop("disabled", true);
		
			var rsaKey = new RSAKey();
			rsaKey.setPublic(b64tohex(modules), b64tohex(exponent));
			
			$.ajax({
				url: ctx + "/login",
				data: {
					username: $username.val(),
					password: hex2b64(rsaKey.encrypt($password.val())),
					type:$('input:radio:checked').val(),
                    redirectUrl : redirectUrl
				},
				type: "post",
				dataType: "json",
				cache: false,
				beforeSend: function(request, settings) {
					request.setRequestHeader("token", $.cookie("token"));
					$submit.val(" 登 录 中 ... ");
				},
				success: function (result) {
					if (result.status == "success") {
						var top = getTopWinow();
						var redirectUrl = result.data.redirectUrl;
                        if (redirectUrl != undefined && redirectUrl != '') {
							top.location.href = ctx + "/" + redirectUrl;
                        } else {
							top.location.href = ctx + "/uc";
						}
					} else {
						$flashMessage.text(result.message).addClass("icon");
						// new $.zui.Messager(result.message, {
						// 	icon: 'heart',
						// 	placement: 'center'
						// }).show();

						modules = result.data.modules, exponent = result.data.exponent;
						$submit.val(" 登 录 ");
						$submit.prop("disabled", false);
					}
				},
				error: function() {
					$flashMessage.text("登录失败，请刷新页面重试");
					$submit.val(" 登 录 失 败 ");
				}
			});
		}
	});
		
	// var $captchaImage = $("#captchaImage");
	// $captchaImage.click(function() {
	// 	$captchaImage.prop("src", ctx + "/captcha?type=LOGIN&timestamp=" + (new Date()).valueOf());
	// });

});

function getTopWinow(){
	var p = window;
	while(p != p.parent){
		p = p.parent;
	}
	return p;
}

	/*点击眼睛改变密码输入框type属性使密码输入可见*/
	$('#toggle-pwd1').click(function () {
		if ($(this).hasClass('see-pwd')) {
			$('#password').attr("type", "text");
			$(this).removeClass('see-pwd');
		} else {
			$('#password').attr("type", "password");
			$(this).addClass('see-pwd');
		}
	})
/**********************************************
 推荐人输入框显示隐藏
 */
$(".tuiarrow,.code .arrow").click(function (event) {
	$('.code_box').slideToggle();
	$(".code .arrow").toggleClass('arrowHover');
});