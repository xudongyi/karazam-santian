/* * Copyright 2016 klzan.com. All rights reserved. * Support: http://www.klzan.com * * JavaScript - Regist * Version: 3.0 */var w, h, className;function getSrceenWH() {    w = $(window).width();    h = $(window).height();    $('#dialogBg').width(w).height(h);}window.onresize = function () {    getSrceenWH();}$(window).resize();$().ready(function() {    var $registBasicForm = $("#registBasicForm"),        $flashMessage = $("#flashMessage"),        $submit = $registBasicForm.find(":submit"),        rsaKey = new RSAKey();    var $mobile = $("#mobile"),        $password = $("#password"),        $rePassword = $("#rePassword"),        $captcha = $("#captcha");        $referrer = $("#referrer"),        $mobileFlashMessage = $("#mobileFlashMessage"),        $captchaButton = $("#captchaButton"),        $userType = "GENERAL";    $submit.prop("disabled", false);    rsaKey.setPublic(b64tohex(modules), b64tohex(exponent));    var $validate = $registBasicForm.validate({        rules: {            mobile: {                required: true,                pattern: /^1[3|4|5|7|8][0-9]{9}$/,                remote: {                    url: ctx + "/regist/check_mobile?type=" + $userType,                    type: "post",                    cache: false                }            },            password: {                required: true,                pattern: /^(?![0-9]+$)(?![a-zA-Z]+$)[0-9a-zA-Z_]+$/,                minlength: 4,                maxlength: 20            },            rePassword: {                required: true,                equalTo: "#password"            },            captcha:{                required: true            },            referrer: {                pattern: /^1[3|4|5|7|8][0-9]{9}$/,                remote: {                    url: ctx + "/regist/check_referrer",                    type: "post",                    cache: false                }            },            agreement: "required"        },        messages: {            mobile: {                required: "请输入您的手机号码",                pattern: "请输入正确的手机号码",                remote: "手机号码已存在"            },            password: {                required: "请输入4-20位密码",                pattern: "密码必须由数字字母组合",                minlength: "请输入4-20位密码",                maxlength: "请输入4-20位密码"            },            rePassword: {                required: "请输入确认密码",                equalTo: "两次密码输入不一致"            },            captcha:{                required: "请输入验证码"            },            referrer: {                pattern: "推荐人格式不正确",                remote: "推荐人不存在"            },            agreement: "请先阅读《注册协议》并确认同意"        },        errorPlacement: function(error, element) {            console.log(error.text());            element.closest(".errorcls").find(".errorMessage").text(error.text());            element.closest(".errorcls").find(".errorMessage").addClass("icon");            $submit.prop("disabled", true);            $flashMessage.text("");        },        unhighlight: function(element) {            $(element).closest(".errorcls").find(".errorMessage").text("");            $(element).closest(".errorcls").find(".errorMessage").removeClass("icon");            $submit.prop("disabled", false);            $flashMessage.text("");        },        submitHandler: function(form) {            $submit.prop("disabled", true);            $.ajax({                url: ctx + "/regist/do",                type: "post",                data: {                    mobile: $mobile.val(),                    type: $userType,                    password: hex2b64(rsaKey.encrypt($password.val())),                    referrer: $referrer.val(),                    captcha:$captcha.val(),                    modules: modules,                    exponent: exponent                },                dataType: "json",                cache: false,                beforeSend: function(request, settings) {                    // $submit.attr("data-toggle","");                    request.setRequestHeader("token", $.cookie("token"));                    $submit.val(" 注 册 中 ... ");                },                success: function(data) {                    if (data.status == "success") {                        $('#myModal').modal({                            backdrop:'static'                        });                    } else {                        $flashMessage.text(data.message);                        $captcha.val("");                        $submit.val(" 注 册 ");                        $submit.prop("disabled", false);                    }                },                error: function() {                    $flashMessage.text("注册失败，请刷新页面重试");                    $submit.val(" 注 册 失 败 ");                }            });        }    });    $(":radio").change(function(){        $userType = $("input:checked").val();        var $mobile = $("#mobile");        $mobile.val("");        $mobile.rules("remove");        $mobile.rules("add",{            remote: {                url: ctx + "/regist/check_mobile?type=" + $userType,                type: "post",                cache: false            },            messages:{                remote: "手机号码已存在"            }        });        $validate.element($mobile);    });    $captchaButton.click(function () {        $captchaButton.prop("disabled", true);        if (!$validate.element($mobile)) {            $captchaButton.prop("disabled", false);            return false;        }        $.ajax({            url: ctx + "/regist/sendMessage",            data: {                mobile: $mobile.val(),                type: $userType,            },            type: "post",            dataType: "json",            cache: false,            success: function (data) {                if (data.status == "success") {                    $mobileFlashMessage.text("");                    $mobileFlashMessage.removeClass("icon");                    $disableButton($captchaButton, 60);                } else {                    $mobileFlashMessage.text(data.message);                    $mobileFlashMessage.addClass("icon");                    $captchaButton.prop("disabled", false);                }            }        });    });    getSrceenWH();    //显示弹框    $('.box a').click(function () {        className = $(this).attr('class');        $('#dialogBg').fadeIn(300);        $('#dialog').removeAttr('class').addClass('animated ' + className + '').fadeIn();    });    //关闭弹窗    $('.claseDialogBtn').click(function () {        $('#dialogBg').fadeOut(300, function () {            $('#dialog').addClass('bounceOutUp').fadeOut();        });    });    $disableButton = function(button, seconds) {        var previousValue = button.val();        var className = button.attr("disableClassName");        var promptValueSuffix = button.attr("disablePromptValueSuffix");        var promptValue = seconds + "秒" + promptValueSuffix;        button.prop("disabled", true);        button.addClass(className);        button.val(promptValue);        intervalId = window.setInterval(function() {            seconds -= 1;            promptValue = seconds + "秒" + promptValueSuffix;            button.val(promptValue);            if(seconds == 0) {                window.clearInterval(intervalId);                button.prop("disabled", false);                button.removeClass(className);                button.val(previousValue);            }        }, 1000);    };    /*点击眼睛改变密码输入框type属性使密码输入可见*/    $('#toggle-pwd1').click(function () {        if ($(this).hasClass('see-pwd')) {            $('#password').attr("type", "text");            $(this).removeClass('see-pwd');        } else {            $('#password').attr("type", "password");            $(this).addClass('see-pwd');        }    })    $('#toggle-pwd2').click(function () {        if ($(this).hasClass('see-pwd')) {            $('#rePassword').attr("type", "text");            $(this).removeClass('see-pwd');        } else {            $('#rePassword').attr("type", "password");            $(this).addClass('see-pwd');        }    })    /**********************************************     推荐人输入框显示隐藏     */    $(".tuiarrow,.code .arrow").click(function (event) {        $('.code_box').slideToggle();        $(".code .arrow").toggleClass('arrowHover');    });});function toToUc() {    window.location.href = ctx + "/uc/index";}function goToSecurity() {    window.location.href = ctx + "/uc/security";}